---
output:
    html_document:
        theme: cerulean
        fig_width: 6
        fig_height: 5
---

<center> <h2>Reproducible Research - Project 1</h2> </center>
<center> By [James Lamb](http://www.linkedin.com/in/jameslamb1/)</center>
<center>-----------------------------------------------------------------------------------------------------------------------------------------------------</center>

###I. Introduction

This is a brief project prepared in partial fulfillment of the requirements for the [Reproducible Research](https://class.coursera.org/repdata-010) course offered by Johns Hopkins University via Coursera, as part of the JHU Data Science Specialization. 

In this project, we were asked to pull in some health data from a personal activity monitoring device, perform some exploratory analysis, and collect our findings in a literate statistical program written in RStudio and compiled in knitr.

###II. The Data

The data were provided by [the instructor](https://twitter.com/rdpeng), and be downloaded [here](http://d396qusza40orc.cloudfront.net/repdata%2Fdata%2Factivity.zip). The included variables are as follows:

- **steps**: Number of steps taken in a 5-minute interval
- **date**: The date on which the measurement was takend in YYYY-MM-DD format
- **interval**: Identifier for the 5-minute interval in which measurement was taken

There are a total of 17,568 observations in the dataset. All missing data were coded as "NA" in the original dataset.

##III. Loading the Data

To make this analysis reproducible on other machines, I began by writing a routine in which R downloads and unzips the data (rather than reading it in from a local directory). After reading in the data, the raw dataset is immediately written back into the working directory in a file called "activity.csv". To improve speed, in future runs of the program, R will first check in the working directory to find "activity.csv" and read directly from it.

Please note that my code uses Windows relative path references. I do not know enough computer science to make these relative paths OS-agnostic. If you (the reader/reviewer) do know, please click my name under the title and send me a message with a resource that explains it. I'm always willing to learn more!

```{r sec3download, echo=TRUE, message=FALSE, warning=FALSE}
###---Loading and Preprocessing the Data---###

## If no directory for the project exists in current directory AND we aren't already in it, create a new directory called "REPROD_PROJECT1" and set the working directory there
if ("REPROD_PROJECT1"%in%list.files()==FALSE & grepl("REPROD_PROJECT1", getwd())==FALSE) {
    dir.create("REPROD_PROJECT1")
    setwd(".\\REPROD_PROJECT1")
}

## if the file exists in the directory, read it in directly. Otherwise, download it, unzip it, read it in, and write it to the directory

if (file.exists(".\\activity.csv")) {
    data <- read.csv(".\\activity.csv", 
                     header=TRUE,
                     stringsAsFactors=FALSE, 
                     colClasses = c("steps"="numeric", "date"="Date", "interval" = "factor"))
} else {
    data_url <- "http://d396qusza40orc.cloudfront.net/repdata%2Fdata%2Factivity.zip"
    temp <- tempfile()
    download.file(data_url, temp)
    data <- read.csv(unz(temp, "activity.csv"), 
                     header=TRUE, stringsAsFactors=FALSE, 
                     colClasses = c("steps"="numeric", "date"="Date", "interval" = "factor"))
    unlink(temp)
    write.csv(data, file=".\\activity.csv")
}
```

###IV. Mean Total Steps

With the data downloaded, it was time to start analyzing it. To begin, I wanted to get a sense of the distribution of activity patterns. The code block below expresses some features of the distribution of total steps taken each day. It plots a histogram (Figure 1) and reports the mean and median daily steps taken.

Note that at this point, missing values were simply ignored by the calculations (i.e. no imputation was done). 

```{r sec4byday, cache=FALSE, fig.align='center'}
###---Analysis of Daily Step Counts---###

## create a new data frame with steps aggregated by day
daytotal_df <- aggregate(steps ~ date, data=data, sum)

## plot a histogram of the total number of steps taken each day

par(bg = "snow2")
hist1 <- hist(daytotal_df$steps, 
              main = "Fig. 1 Histogram of Steps Per Day", 
              xlab = "Steps Per Day",
              col = "violetred4")

## calculate the mean and median, round them for cleaner reporting
mean1 <- round(mean(daytotal_df$steps), digits=0)        
    mean_text <- as.character(mean1)                     ## character, for human-readable
median1 <- round(median(daytotal_df$steps), digits=0)   
    median_text <- as.character(median1)                 ## character, for human-readable
```

In this sample, total daily steps averaged `r mean_text`, with a median of `r median_text`. 

### V. What is the Average Daily Activity Pattern?

Next, I took a look at the intraday patterns in walking activity. The code below generates a time-series plot (Figure 2) of average steps taken at each 5-minute interval, averaged across all days in the sample. 

As was fairly noted [on the course forums](https://class.coursera.org/repdata-010/forum/thread?thread_id=11), the notion of "time" on the x-axis is not technically correct. The data are coded as {8:00a = 800, 12:45p = 1245, 11:55p = 2355, etc.}. This means that we are dealing with a non-continuous, non-evenly-spaced measure of time on the x axis. This means that gaps between realizations may distort the time series properties of the data.

In this project, I neglected to make special allowances for this technical note. I feel justified in leaving the time scale as-is for the following reasons:

1. It is not obvious that professor Peng made such adjustments (compare [the example panel plot](https://github.com/JayLamb20/RepData_PeerAssessment1/blob/master/instructions_fig/sample_panelplot.png) with my Figure 4 below)
2. The goal here is to determine a maximum point, not any time-series characteristics like autocorrelation. The visual representation of the maximum is not affected by the scale distortion.

```{r sec5dailyactivity, message=FALSE, warning=FALSE, fig.align='center'}
###---Figuring Out Interday Averages at Each Interval---###

# convert interval (currently factor) into numeric (for correct sorting)
data$intnum <- as.numeric(as.character(data$interval))

#create a new dataframe, taking averages by interval
mintotal_df <- aggregate(steps ~ intnum, data=data, mean)

par(bg = "snow2")
#create a time series plot of average steps taken
plot(mintotal_df$intnum, 
     mintotal_df$steps,
     type = "l",
     main = "Fig. 2 Average Steps At Each Five-Minute-Interval, All Days",
     xlab = "5-minute daily interval",
     ylab = "Average Steps Taken",
     col = "violetred4")

max1 <- max(mintotal_df$steps)
    max1_text <- round(max1, 0)
max1_int <- mintotal_df[mintotal_df$steps==max1,1] #interval with highest average steps

#convert interval into human readable time (e.g. 800 = "8:00 a.m.")

if(nchar(as.character(max1_int))==1) {
    max1_int_text <- paste("12:0", as.character(max1_int), " a.m.", sep="")
} 

if(nchar(as.character(max1_int))==2) {
    max1_int_text <- paste("12:", as.character(max1_int), " a.m.", sep="")
} 

if(nchar(as.character(max1_int))==3) {
    max1_int_text <- paste(substr(as.character(max1_int),1,1)
                           , ":",substr(as.character(max1_int),2,3), 
                           " a.m.", sep="")
} 

if(nchar(as.character(max1_int))==4 & max1_int <= 1155) {
    max1_int_text <- paste(substr(as.character(max1_int),1,2)
                           , ":",substr(as.character(max1_int),3,4), 
                           " a.m.", sep="")
}

if(nchar(as.character(max1_int))==4 & max1_int >= 1200) {
    max1_int_text <- paste(substr(as.character(max1_int),1,2)
                           , ":", substr(as.character(max1_int),3,4), 
                           "p.m", sep="")
}
```

For this sample, it appears that average daily steps taken was highest in the five-minute interval beginning at `r max1_int_text`. On average, subjects took `r max1_text` steps during this interval.

###VI. Imputing Missing Values

Next, I took a look at the severity of the missing-value problem in this dataset. The code below calculates the total number of records with missing values and the proportion of the sample they represent.

```{r sec6aimputation, message=FALSE, warning=FALSE, fig.align='center'}
###---Severity of the Missing-Value Problem---###

#calculate the total number of missing values
totrec_text <- as.character(nrow(data))

#count the number of NAs and the % of observations they represent
nacount <- nrow(data[is.na(data$steps),])
    na_count_text <- as.character(nacount) #pretty for the text
naprop <- round(100*(nacount/nrow(data)),2)
    naprop_text <- paste(as.character(naprop), "%", sep="") #pretty for the text

```

The data studied here are far from perfect. Of the `r totrec_text` lines of data in the dataset, `r na_count_text` (`r naprop_text`) are missing values. 

In an attempt to address this issue, I use mean imputation to replace the missing values. This introduces [well-known biases](http://www.stat.columbia.edu/~gelman/arm/missing.pdf), but none that I expect to influence the very basic analysis undertaken in this project.The specific mean chosen the interday average steps taken at each interval.

```{r sec6bimputation, message=FALSE, warning=FALSE, fig.align='center'}
###---Replacing the NAs---###

## create a new dataset with NAs filled in
dimp <- data

## fill in NAs with across-day, within-interval mean
dimp[is.na(dimp$steps),]$steps <- mintotal_df[mintotal_df$intnum==dimp[is.na(dimp$steps),]$intnum,2]


## create a new data frame with steps aggregated by day
dimptot <- aggregate(steps ~ date, data=dimp, sum)

## plot a histogram of the total number of steps taken each day
par(bg = "snow2")

## plot the histograms next to each other
par(mfrow = c(1,2), mar=c(5,5,5,2), cex.main=0.7)
hist1 <- hist(daytotal_df$steps, 
              main = "Fig. 1 Histogram of Steps Per Day", 
              xlab = "Steps Per Day",
              col = "violetred4")
hist2 <- hist(dimptot$steps, 
              main = "Fig. 3 Histogram of Steps Per Day \n(NAs Replaced with Mean Imputation)",
              xlab = "Steps Per Day",
              col = "violetred4")

## calculate the mean and median, round them for cleaner reporting
mean2 <- round(mean(dimptot$steps), digits=0)
    mean2_text <- as.character(mean2)
median2 <- round(median(dimptot$steps), digits=0)
    median2_text <- as.character(median2)
```

Figure 3 above shows the distribution of interday mean step counts at each 5-minute interval. Figure 1 is reprinted here to the left of Figure 3. At first glance, the distributions to not appear to be substantially different.

Unsurprisingly, this distribution is nearly identical (in central tendency) to the one calculated with missing values dropped. In the new dataset, with NAs replaced using mean imputation, the mean is `r mean2_text` and the median is `r median2_text`. 

However, an additional question remains...what happened to the counts? Certainly, adding in those `r na_count_text` imputed records changed the densities at different points in the distribution (even if central tendency remained unchanged). To examine this, I used the code below to generate Figure 5, which overlays the distributions of the missing-values and no-missing-values distributions

```{r sec6ccomparedist, message=FALSE, warning=FALSE, fig.align='center'}
###---Comparing the Distributions---###
library(ggplot2)

## make a data frame where we sum across days, using no-imputation sample
origdata <- aggregate(steps ~ date, data=data, sum)
dimptot <- dimptot

## assign distribution indicators

## bind the data together


## plot the overlapping histograms
ggplot()
thesource <- http://blog.lib.umn.edu/jeli0026/soils/2014/01/making-kick-ass-histograms-and-density-plots-with-ggplot2.html

```

#Are There Differences in Activity Patterns Between Weekdays and Weekends?

```{r, message=FALSE, warning=FALSE, fig.align='center'}
#Weekday vs. Weekend distinction
data$day <- "Weekday"
data[substr(weekdays(data$date),1,1)=="S",]$day <- "Weekend"
data$day <- as.factor(data$day)


#new dataset with averages across interval/day distinciton
data$weekfac <- paste0(as.character(data$day), as.character(data$intnum))
weekdif <- aggregate(steps ~ weekfac+day+intnum, data=data, mean)

#Panel Plot

#make a new data frame with within-interval averages
library(lattice)
xyplot(steps ~ intnum | day, 
       data=weekdif, 
       type="l",
       main = "Average Steps by 5-Minute Interval \nWeekdays vs. Weekends",
       xlab = "Time of Day (5-min Interval)",
       ylab = "Average Steps Taken",
       layout = c(1,2)
       )

#Let's look at a simple linear correlation
corr1 <- cor(weekdif[weekdif$day=="Weekday","steps"], weekdif[weekdif$day=="Weekend","steps"])
```



#References

In this type of project, novice users like me inevitably end up scouring Inside-R, Stack, CRAN, r-bloggers, and elsewhere in search of helpful hints and solutions to error messages. The links below are presented to give credit where credit is due. I hope that you find them as useful as I did.

[1] http://stackoverflow.com/questions/3053833/using-r-to-download-zipped-data-file-extract-and-import-data 

[2] http://www.r-bloggers.com/using-colclasses-to-load-data-more-quickly-in-r/ 

[3] http://stackoverflow.com/questions/21607464/what-is-the-equivalent-of-the-sumif-function-in-r 

[4] http://www.statmethods.net/advgraphs/parameters.html

[5] http://www.stat.columbia.edu/~tzheng/files/Rcolor.pdf

[6] http://stackoverflow.com/questions/19890633/r-produces-unsupported-url-scheme-error-when-getting-data-from-https-sites

[7] http://r.789695.n4.nabble.com/Invalid-plot-type-1-td2318088.html

[8] http://stackoverflow.com/questions/6774339/r-how-do-i-put-two-box-plots-next-to-each-other-keeping-same-y-range-for-both

[9] http://seananderson.ca/courses/11-multipanel/multipanel.pdf

[10] http://yihui.name/knitr/options/#chunk_options

[11] http://rmarkdown.rstudio.com/html_document_format.html

[12] http://stackoverflow.com/questions/15978985/how-to-aggregate-some-columns-while-keeping-other-columns-in-r

[13] http://cran.r-project.org/web/packages/lattice/lattice.pdf
